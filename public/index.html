<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h2>My id: <span id="myid"></span></h2>

    <div>
        online users
        <div id="onlineUsers">

        </div>
    </div>
    <div>
        <button onclick="sendNotification('one')" id="nBtn">
            Send notification
        </button>
        <button onclick="sendNotification('all')">
            broadcast notification
        </button>
        <button onclick="sendNotification('some')">
            invite Team
        </button>


        <button onclick="createTeam()">
            create team
        </button>
    </div>
    <br>
    <div style="height: 100px;border-style: solid;width: 30rem">
        notification
        <div id="notification">

        </div>
    </div>
    <br>
    <div style="border-style: solid;width: 50rem;">
        <h3>chat</h3> <select id="userSelect">

        </select>
        <div id="chat" style="height: 400px;"></div>
        <form id="chatForm">
            <input type="text" name="msg" style="width: 40rem; height: 40px;"><button type="submit"
                style=" height: 42px;">send</button>
        </form>
    </div>
    <!-- <button onclick="check('app1')">App1</button>
    <button onclick="check('app2')">App2</button> -->




    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>



    <script>
        io();
        const socket = io('/app1')
        // const socket2 = io('/app1')
        // const socket3 = io('/app2')
        const onlineUserDiv = document.getElementById("onlineUsers")
        let uid;
        const chatForm = document.getElementById("chatForm")
        const userSelect = document.getElementById("userSelect")
        //         function check(mode) {
        //             switch (mode) {
        //                 case 'app1':
        //                     socket2.emit("hello", { msg: "hello from app1" })
        //                     break;
        //                     case 'app2':
        //                     socket3.emit("hello", { msg: "hello from app2" })
        // break;
        //             }
        //         }
        window.onload = () => {
            uid = uuid()
            console.log(uid)
            document.getElementById("myid").innerHTML = uid
            //joining the room

            register('room');

            //on sending msg
            chatForm.addEventListener('submit', e => {
                e.preventDefault()
                // if(userSelect.value == "team1"){

                // }
                socket.emit("send-message", JSON.stringify({
                    room: userSelect.value,
                    msg: chatForm.msg.value
                }))
                document.getElementById("chat").innerHTML += `<p>me: ${chatForm.msg.value}</p>`
                chatForm.reset()
            })



            //on recieving a msg
            socket.on("message", payload => {
                document.getElementById("chat").innerHTML += `<p>other: ${payload}</p>`
            })

            //getting all online users
            socket.on('online-users', payload => {
                console.log(payload)
                payload = JSON.parse(payload)
                onlineUserDiv.innerHTML = ''
                userSelect.innerHTML = ''
                Object.keys(payload).forEach(key => {
                    // console.log(key)
                    if (payload[key]["uid"] !== uid) {
                        onlineUserDiv.innerHTML += `
                <p>${payload[key]["uid"]}</p>
                `
                        userSelect.innerHTML += `<option>${payload[key]["uid"]}</option>`
                    }


                })
                userSelect.innerHTML += `<option>team1</option>`
            })


            //if any user signout
            socket.on("user-signout", (data) => {
                console.log("this user signout!", data)
                alert(`${data.user["uid"]} signout`)
                socket.emit("get-online-users", {})
            })

            //listening to notifications
            socket.on("notification", payload => {
                payload = JSON.parse(payload)
                if (payload['msg'].includes('invite')) {
                    document.getElementById('notification').innerHTML = `
                    <p>${payload.msg}</p><button onclick="register('team')">Join team</button>
                    `
                } else {
                    alert(payload['msg']);

                }
            })




        }
        //send the notification
        function sendNotification(mode) {
            if (mode == 'one') {
                let id = prompt("Enter the uid")
                console.log(id)
                socket.emit('send-notification', JSON.stringify({
                    room: id,
                    msg: 'Hello! its a notification.',
                    mode: 'one'
                }))
            } else if (mode == 'some') {
                let id = prompt('Enter all ids with comma seperated')
                let users = id.split(',');
                console.log(users)
                socket.emit('send-notification', JSON.stringify({
                    users,
                    msg: 'invite to join team1',
                    mode: 'some'
                }))
            }
            else {
                socket.emit('send-notification', JSON.stringify({

                    msg: 'Hello! its a broadcast notification.',
                    mode: 'all'
                }))
            }

        }

        function createTeam() {
            console.log('in create team')
            socket.emit('create-team', JSON.stringify({
                team: 'team1'
            }))
        }
        function register(mode) {
            switch (mode) {
                case 'room':
                    socket.emit("join-room", JSON.stringify({ uid, mode: 'room' }));
                    break;
                case 'team':
                    socket.emit("join-room", JSON.stringify({ team: 'team1', mode: 'team' }));
                    break;
            }
        }
        function uuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>

</html>